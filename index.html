<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾…è¾¦äº‹é …å°å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #f1f5f9; color: #1e293b; }
        .task-card { transition: all 0.25s ease; border: 1px solid rgba(255,255,255,0.8); }
        .task-card:hover { transform: translateY(-3px); box-shadow: 0 12px 24px -10px rgba(0,0,0,0.05); }
        .glass-modal { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); }
        .pulse-btn { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const PRIORITY_MAP = {
            high: { label: 'ğŸ”¥ ç·Šæ€¥', bg: 'bg-rose-100', text: 'text-rose-600', dot: 'bg-rose-500' },
            medium: { label: 'âš¡ æ™®é€š', bg: 'bg-amber-100', text: 'text-amber-600', dot: 'bg-amber-500' },
            low: { label: 'ğŸŒ± ä½å„ªå…ˆ', bg: 'bg-emerald-100', text: 'text-emerald-600', dot: 'bg-emerald-500' },
            home: { label: 'ğŸ  å®¶å‹™', bg: 'bg-indigo-100', text: 'text-indigo-600', dot: 'bg-indigo-500' }
        };

        function App() {
            const [tasks, setTasks] = useState([]);
            const [view, setView] = useState('active');
            const [selectedTask, setSelectedTask] = useState(null);
            const [form, setForm] = useState({ text: '', priority: 'medium', end: '' });
            const [showAddForm, setShowAddForm] = useState(false);
            const [tempText, setTempText] = useState('');
            const [activeInput, setActiveInput] = useState({ type: null, issueId: null });
            const [isLoaded, setIsLoaded] = useState(false);
            
            // ä½¿ç”¨ Ref ä¾†é¿å… useEffect é–‰åŒ…å•é¡Œ
            const tasksRef = useRef([]);
            useEffect(() => { tasksRef.current = tasks; }, [tasks]);

            const CLOUD_URL = "https://script.google.com/macros/s/AKfycbwVZtUFKOj2Gqv2jMj43F02w88p1JK4D8hyz49YzMPbJbymhHdnZVPfbgQ6OP5_IFUR/exec";

            // è®€å–
            useEffect(() => {
                const load = async () => {
                    try {
                        const res = await fetch(CLOUD_URL);
                        const data = await res.json();
                        if (Array.isArray(data)) {
                            setTasks(data);
                        }
                    } catch (e) { console.error("Load Error", e); }
                    finally { setIsLoaded(true); }
                };
                load();
            }, []);

            // åŒæ­¥ (å¢åŠ é˜²æŠ–ï¼Œé¿å…å¯«å…¥éæ–¼é »ç¹å°è‡´ Sheet æ²’å­˜åˆ°)
            useEffect(() => {
                if (isLoaded) {
                    const timer = setTimeout(() => {
                        fetch(CLOUD_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ tasks }) });
                        localStorage.setItem('vibe-tasks-final', JSON.stringify(tasks));
                    }, 500); 
                    return () => clearTimeout(timer);
                }
            }, [tasks, isLoaded]);

            // ä¿®æ­£åˆªé™¤é‚è¼¯ï¼šæ‰‹å‹•æ¸…ç† State
            const deleteTask = (e, id) => {
                e.stopPropagation(); // å¾¹åº•åˆ‡æ–·å†’æ³¡
                if (confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) {
                    const nextTasks = tasks.filter(t => t.id !== id);
                    setTasks(nextTasks);
                    setSelectedTask(null);
                }
            };

            const toggleTask = (e, id) => {
                e.stopPropagation();
                setTasks(prev => prev.map(t => {
                    if (t.id === id) {
                        const newStatus = !t.isDone;
                        return { ...t, isDone: newStatus, progress: newStatus ? 100 : (t.progress === 100 ? 0 : t.progress) };
                    }
                    return t;
                }));
            };

            const updateTask = (id, field, value) => {
                setTasks(prev => prev.map(t => t.id === id ? { ...t, [field]: value } : t));
                if (selectedTask?.id === id) setSelectedTask(prev => ({ ...prev, [field]: value }));
            };

            // æ–°å¢å•é¡Œèˆ‡è§£ç­”
            const addIssue = (taskId) => {
                if (!tempText.trim()) return;
                updateTask(taskId, 'issues', [...(tasks.find(t=>t.id===taskId).issues || []), { id: Date.now(), q: tempText, a: '', done: false }]);
                setTempText(''); setActiveInput({type:null, issueId:null});
            };

            const solveIssue = (taskId, issueId) => {
                if (!tempText.trim()) return;
                const newIssues = (tasks.find(t=>t.id===taskId).issues || []).map(is => is.id === issueId ? { ...is, a: tempText, done: true } : is);
                updateTask(taskId, 'issues', newIssues);
                setTempText(''); setActiveInput({type:null, issueId:null});
            };

            const filteredTasks = tasks.filter(t => view === 'active' ? !t.isDone : t.isDone);

            return (
                <div className="min-h-screen flex">
                    <aside className="w-16 md:w-56 bg-white border-r border-slate-200 flex flex-col sticky top-0 h-screen">
                        <div className="p-6 font-black text-indigo-600 text-center md:text-left">å¾…è¾¦äº‹é …</div>
                        <nav className="flex-1 px-3 space-y-2">
                            <button onClick={() => setView('active')} className={`w-full p-3 rounded-xl text-xs font-bold ${view === 'active' ? 'bg-indigo-600 text-white' : 'text-slate-500 hover:bg-slate-50'}`}>ğŸ“Š é€²è¡Œä¸­</button>
                            <button onClick={() => setView('completed')} className={`w-full p-3 rounded-xl text-xs font-bold ${view === 'completed' ? 'bg-emerald-600 text-white' : 'text-slate-500 hover:bg-slate-50'}`}>âœ… å·²å®Œæˆ</button>
                        </nav>
                    </aside>

                    <main className="flex-1 p-8 max-w-5xl">
                        <header className="flex justify-between items-center mb-10">
                            <h2 className="text-xl font-black">{view === 'active' ? 'ä»»å‹™å„€è¡¨æ¿' : 'æˆå°±ç´€éŒ„åº«'}</h2>
                            <button onClick={() => setShowAddForm(true)} className="pulse-btn bg-indigo-600 text-white px-6 py-2 rounded-full font-bold text-xs shadow-lg">+ æ–°å¢ä»»å‹™</button>
                        </header>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                            {filteredTasks.map(task => (
                                <div key={task.id} onClick={() => setSelectedTask(task)} className="task-card bg-white p-5 rounded-3xl cursor-pointer relative">
                                    <div className="flex justify-between items-start mb-4">
                                        <div className={`px-2 py-0.5 rounded text-[9px] font-black ${PRIORITY_MAP[task.priority]?.bg} ${PRIORITY_MAP[task.priority]?.text}`}>{PRIORITY_MAP[task.priority]?.label}</div>
                                        <div onClick={(e) => toggleTask(e, task.id)} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${task.isDone ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-200'}`}>
                                            {task.isDone && 'âœ“'}
                                        </div>
                                    </div>
                                    <h3 className={`font-bold text-sm mb-4 ${task.isDone ? 'text-slate-300 line-through' : 'text-slate-700'}`}>{task.text}</h3>
                                    <div className="w-full bg-slate-100 h-1 rounded-full overflow-hidden">
                                        <div className="h-full bg-indigo-500 transition-all duration-500" style={{ width: `${task.progress}%` }}></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </main>

                    {/* è©³ç´°è³‡æ–™ Modal */}
                    {selectedTask && (
                        <div className="fixed inset-0 z-50 glass-modal flex items-center justify-center p-4" onClick={() => setSelectedTask(null)}>
                            <div className="bg-white w-full max-w-xl rounded-[2rem] shadow-2xl p-8 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between mb-6">
                                    <h2 className="font-black text-slate-800">ä»»å‹™è©³æƒ…</h2>
                                    <button onClick={() => setSelectedTask(null)} className="text-slate-300 text-2xl">&times;</button>
                                </div>
                                <div className="space-y-6">
                                    <h3 className="text-lg font-bold text-indigo-600 border-l-4 border-indigo-600 pl-3">{selectedTask.text}</h3>
                                    <div className="bg-slate-50 p-5 rounded-2xl">
                                        <div className="flex justify-between mb-2 text-[10px] font-black text-slate-400 uppercase"><span>å®Œæˆåº¦</span><span>{selectedTask.progress}%</span></div>
                                        <input type="range" className="w-full h-1.5 accent-indigo-600" value={selectedTask.progress} onChange={e => updateTask(selectedTask.id, 'progress', e.target.value)} />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-[10px] font-black text-slate-400 uppercase">è©³ç´°æè¿°</label>
                                        <textarea className="w-full bg-slate-50 p-4 rounded-xl h-24 text-sm font-medium outline-none" value={selectedTask.description || ''} onChange={e => updateTask(selectedTask.id, 'description', e.target.value)} placeholder="ä»»å‹™èªªæ˜..." />
                                    </div>

                                    {/* å•é¡Œå€å¡Š */}
                                    <div className="pt-4 border-t border-slate-100">
                                        <div className="flex justify-between items-center mb-4"><span className="text-[10px] font-black text-slate-800">å•é¡Œç´€éŒ„</span><button onClick={() => setActiveInput({type:'issue'})} className="text-[9px] bg-slate-100 px-2 py-1 rounded-lg">+ æ–°å¢å•é¡Œ</button></div>
                                        <div className="space-y-3">
                                            {activeInput.type === 'issue' && (
                                                <div className="flex gap-2"><input autoFocus className="flex-1 bg-slate-50 p-2 rounded text-xs outline-none font-bold" value={tempText} onChange={e=>setTempText(e.target.value)} onKeyDown={e=>e.key==='Enter' && addIssue(selectedTask.id)} /><button onClick={()=>addIssue(selectedTask.id)} className="bg-indigo-600 text-white px-3 rounded text-[10px]">é€å‡º</button></div>
                                            )}
                                            {(selectedTask.issues || []).map(is => (
                                                <div key={is.id} className={`p-4 rounded-xl border ${is.done ? 'bg-emerald-50 border-emerald-100' : 'bg-rose-50 border-rose-100'}`}>
                                                    <div className="flex justify-between items-start gap-4"><span className={`text-[11px] font-bold ${is.done ? 'text-slate-400 line-through' : 'text-rose-700'}`}>Q: {is.q}</span>{!is.done && <button onClick={()=>setActiveInput({type:'solution', issueId:is.id})} className="text-[9px] bg-blue-500 text-white px-2 py-0.5 rounded">è§£æ±º</button>}</div>
                                                    {is.done && <p className="mt-2 text-[10px] text-emerald-700 font-bold bg-white/50 p-2 rounded italic">Ans: {is.a}</p>}
                                                    {activeInput.type === 'solution' && activeInput.issueId === is.id && (
                                                        <div className="mt-2 flex gap-2"><input autoFocus className="flex-1 border p-2 rounded text-xs outline-none" value={tempText} onChange={e=>setTempText(e.target.value)} onKeyDown={e=>e.key==='Enter' && solveIssue(selectedTask.id, is.id)} /><button onClick={()=>solveIssue(selectedTask.id, is.id)} className="bg-blue-600 text-white px-3 rounded text-[10px]">å„²å­˜</button></div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="flex gap-4 pt-6">
                                        <button onClick={(e) => { toggleTask(e, selectedTask.id); setSelectedTask(null); }} className={`flex-1 py-3 rounded-xl font-black text-xs shadow-md ${selectedTask.isDone ? 'bg-slate-100 text-slate-500' : 'bg-emerald-500 text-white'}`}>
                                            {selectedTask.isDone ? 'é‚„åŸç‚ºé€²è¡Œä¸­' : 'æ¨™è¨˜ç‚ºå·²å®Œæˆ'}
                                        </button>
                                        <button onClick={(e) => deleteTask(e, selectedTask.id)} className="px-5 bg-rose-50 text-rose-500 rounded-xl font-bold text-[10px] hover:bg-rose-500 hover:text-white transition-all">åˆªé™¤ä»»å‹™</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* æ–°å¢ä»»å‹™å½ˆçª— */}
                    {showAddForm && (
                        <div className="fixed inset-0 z-50 glass-modal flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl">
                                <h2 className="text-base font-black mb-6 text-center text-slate-800">å»ºç«‹æ–°ä»»å‹™</h2>
                                <div className="space-y-4">
                                    <input autoFocus className="w-full bg-slate-50 p-4 rounded-xl outline-none font-bold text-sm" placeholder="ä»»å‹™åç¨±..." value={form.text} onChange={e => setForm({...form, text: e.target.value})} />
                                    <div className="grid grid-cols-2 gap-3">
                                        <select className="bg-slate-50 p-3 rounded-xl font-bold text-xs" value={form.priority} onChange={e => setForm({...form, priority: e.target.value})}><option value="high">ğŸ”´ ç·Šæ€¥</option><option value="medium">ğŸŸ¡ æ™®é€š</option><option value="low">ğŸŸ¢ ä½å„ªå…ˆ</option><option value="home">ğŸ  å®¶å‹™</option></select>
                                        <input type="date" className="bg-slate-50 p-3 rounded-xl font-bold text-[10px]" value={form.end} onChange={e => setForm({...form, end: e.target.value})} />
                                    </div>
                                    <div className="flex gap-3 pt-4">
                                        <button onClick={() => { if(!form.text.trim()) return; setTasks([{id:Date.now(), ...form, progress:0, issues:[], isDone:false}, ...tasks]); setShowAddForm(false); setForm({text:'', priority:'medium', end:''}); }} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-black text-xs shadow-xl">éƒ¨ç½²ä»»å‹™</button>
                                        <button onClick={() => setShowAddForm(false)} className="px-4 text-slate-400 font-bold text-[10px]">å–æ¶ˆ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>